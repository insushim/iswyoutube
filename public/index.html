<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìœ íŠœë¸Œ ì˜ìƒ ìƒì„±ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .topic-card { transition: all 0.3s; cursor: pointer; }
        .topic-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .topic-card.selected { border: 3px solid #667eea; background: #f0f4ff; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tag-high { background: #dcfce7; color: #166534; }
        .tag-medium { background: #fef9c3; color: #854d0e; }
        .step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .step { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .step.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .step.completed { background: #22c55e; color: white; }
        .step.inactive { background: #e5e7eb; color: #9ca3af; }
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <span class="text-4xl">ğŸ¬</span> AI ìœ íŠœë¸Œ ì˜ìƒ ìƒì„±ê¸°
                </h1>
                <p class="text-purple-200 mt-1">í´ë¦­ ëª‡ ë²ˆìœ¼ë¡œ ìœ íŠœë¸Œ ì˜ìƒ ì™„ì„±!</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-purple-200">Powered by</p>
                <p class="font-bold">Gemini 2.5 Flash</p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto py-8 px-4">
        <!-- Step Indicator -->
        <div class="step-indicator mb-8">
            <div class="step active" id="step1">1</div>
            <div class="w-16 h-1 bg-gray-300 self-center rounded" id="line1"></div>
            <div class="step inactive" id="step2">2</div>
            <div class="w-16 h-1 bg-gray-300 self-center rounded" id="line2"></div>
            <div class="step inactive" id="step3">3</div>
        </div>

        <!-- Step 1: ì£¼ì œ ì„ íƒ -->
        <section id="section1" class="fade-in">
            <div class="card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-3xl">ğŸ’¡</span> AI ì¶”ì²œ ì£¼ì œ
                    </h2>
                    <button onclick="getNewTopics()" class="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition">
                        <span>ğŸ”„</span> ìƒˆë¡œìš´ ì¶”ì²œ
                    </button>
                </div>
                <p class="text-gray-600 mb-4">ì¡°íšŒìˆ˜ê°€ ì˜ ë‚˜ì˜¤ëŠ” ì£¼ì œë¥¼ AIê°€ ì¶”ì²œí•´ë“œë ¤ìš”. í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”!</p>

                <div id="topicsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Topics will be loaded here -->
                    <div class="loading text-center py-8 col-span-2">
                        <div class="text-4xl mb-2">ğŸ¤–</div>
                        <p class="text-gray-500">AI ì¶”ì²œ ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- ì§ì ‘ ì…ë ¥ -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>âœï¸</span> ë˜ëŠ” ì§ì ‘ ì…ë ¥
                </h3>
                <div class="flex gap-4">
                    <input type="text" id="customTopic" placeholder="ì›í•˜ëŠ” ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">
                    <button onclick="selectCustomTopic()" class="btn-primary text-white px-6 py-3 rounded-xl font-medium transition">
                        ì„ íƒ
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: ì„¤ì • -->
        <section id="section2" class="hidden fade-in">
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="text-3xl">âš™ï¸</span> ì˜ìƒ ì„¤ì •
                </h2>

                <div class="bg-purple-50 p-4 rounded-xl mb-6">
                    <p class="text-sm text-purple-600 mb-1">ì„ íƒëœ ì£¼ì œ</p>
                    <p class="text-xl font-bold text-gray-800" id="selectedTopicDisplay"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ì¹´í…Œê³ ë¦¬</label>
                        <select id="category" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="technology">ğŸ¤– ê¸°ìˆ /AI</option>
                            <option value="finance">ğŸ’° ì¬í…Œí¬/ê²½ì œ</option>
                            <option value="history">ğŸ“œ ì—­ì‚¬</option>
                            <option value="science">ğŸ”¬ ê³¼í•™</option>
                            <option value="mystery">ğŸ”® ë¯¸ìŠ¤í„°ë¦¬</option>
                            <option value="health">ğŸ’ª ê±´ê°•</option>
                            <option value="lifestyle">ğŸŒŸ ë¼ì´í”„ìŠ¤íƒ€ì¼</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¨ ì˜ìƒ ìŠ¤íƒ€ì¼</label>
                        <select id="style" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="kurzgesagt">ğŸŒŒ Kurzgesagt (ìš°ì£¼ì  ê´€ì )</option>
                            <option value="knowledge_pirate">ğŸ´â€â˜ ï¸ ì§€ì‹í•´ì ë‹¨ (ì¹œê·¼í•œ ì„¤ëª…)</option>
                            <option value="veritasium">ğŸ” Veritasium (íƒêµ¬í˜•)</option>
                            <option value="infographic">ğŸ“Š ì¸í¬ê·¸ë˜í”½ (ë°ì´í„° ì¤‘ì‹¬)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">â±ï¸ ì˜ìƒ ê¸¸ì´</label>
                        <select id="duration" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="300">5ë¶„ (ìˆí¼)</option>
                            <option value="600" selected>10ë¶„ (í‘œì¤€)</option>
                            <option value="900">15ë¶„ (ê¸´ ì˜ìƒ)</option>
                            <option value="1200">20ë¶„ (ì‹¬ì¸µ ë¶„ì„)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ ì–¸ì–´</label>
                        <select id="language" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                            <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-4 mt-8">
                    <button onclick="goToStep(1)" class="px-6 py-3 border-2 border-gray-300 rounded-xl font-medium hover:bg-gray-100 transition">
                        â† ì´ì „
                    </button>
                    <button onclick="generateScript()" class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium transition flex items-center justify-center gap-2">
                        <span>ğŸš€</span> ìŠ¤í¬ë¦½íŠ¸ ìƒì„±í•˜ê¸°
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 3: ê²°ê³¼ -->
        <section id="section3" class="hidden fade-in">
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="text-3xl">ğŸ“</span> ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸
                </h2>

                <div id="generatingStatus" class="text-center py-12">
                    <div class="text-6xl mb-4 loading">ğŸ¤–</div>
                    <p class="text-xl font-medium text-gray-700">AIê°€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ê³  ìˆì–´ìš”...</p>
                    <p class="text-gray-500 mt-2">ì•½ 30ì´ˆ~1ë¶„ ì •ë„ ê±¸ë¦½ë‹ˆë‹¤</p>
                    <div class="progress-bar w-64 mx-auto mt-4">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <div id="scriptResult" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                        <p class="text-green-700 font-medium flex items-center gap-2">
                            <span class="text-xl">âœ…</span> ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
                        </p>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ¯ ì¶”ì²œ ì œëª©</h3>
                        <div id="suggestedTitles" class="space-y-2"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ¬ ì˜¤í”„ë‹ í›„í¬</h3>
                        <div id="hooks" class="bg-yellow-50 p-4 rounded-xl"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ“œ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸</h3>
                        <div id="fullScript" class="bg-gray-50 p-4 rounded-xl whitespace-pre-wrap text-gray-700 max-h-96 overflow-y-auto"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸</h3>
                        <div id="keyPoints" class="space-y-2"></div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="copyScript()" class="flex-1 px-6 py-3 bg-gray-100 rounded-xl font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2">
                            <span>ğŸ“‹</span> ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
                        </button>
                        <button onclick="saveProject()" class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium transition flex items-center justify-center gap-2">
                            <span>ğŸ’¾</span> í”„ë¡œì íŠ¸ ì €ì¥
                        </button>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <button onclick="startOver()" class="w-full px-6 py-3 border-2 border-purple-300 text-purple-700 rounded-xl font-medium hover:bg-purple-50 transition">
                            ğŸ”„ ìƒˆë¡œìš´ ì˜ìƒ ë§Œë“¤ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ìµœê·¼ í”„ë¡œì íŠ¸ -->
        <section class="card p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“‚</span> ìµœê·¼ í”„ë¡œì íŠ¸
            </h2>
            <div id="recentProjects" class="space-y-3">
                <p class="text-gray-500 text-center py-4">ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p>AI ìœ íŠœë¸Œ ì˜ìƒ ìƒì„±ê¸° v2.0</p>
            <p class="text-sm mt-1">Firebase + Gemini 2.5 Flash</p>
        </div>
    </footer>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyC6sH9sNQs7rCuau0m0u3mwG9p9p4kfYOA",
            authDomain: "tts-pro-80ebc.firebaseapp.com",
            projectId: "tts-pro-80ebc",
            storageBucket: "tts-pro-80ebc.firebasestorage.app",
            messagingSenderId: "567421649132",
            appId: "1:567421649132:web:5f5d04c501b0bec26125c9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Gemini API í‚¤
        const GEMINI_API_KEY = "AIzaSyCrQ4dGHPXR2P2UNa5LpdG8GLvdxS4Y2Nw";

        // ìƒíƒœ ê´€ë¦¬
        let selectedTopic = null;
        let currentScript = null;
        let currentStep = 1;

        // Gemini API í˜¸ì¶œ (ìë™ ëª¨ë¸ ì „í™˜)
        async function callGeminiAPI(prompt, config = {}) {
            const models = ['gemini-2.5-flash', 'gemini-2.0-flash', 'gemini-1.5-flash'];

            for (const model of models) {
                try {
                    console.log(`Trying model: ${model}`);
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: config.temperature || 0.7, maxOutputTokens: config.maxTokens || 8000 }
                        })
                    });

                    const data = await response.json();
                    console.log(`${model} response:`, data);

                    if (data.candidates && data.candidates[0]) {
                        return { success: true, data, model };
                    }

                    if (data.error?.message?.includes('overloaded')) {
                        console.log(`${model} is overloaded, trying next model...`);
                        continue;
                    }

                    console.log(`${model} failed:`, data.error?.message);
                } catch (e) {
                    console.log(`${model} error:`, e);
                }
            }

            return { success: false, error: 'ëª¨ë“  ëª¨ë¸ì´ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', () => {
            loadTopics();
            loadRecentProjects();
        });

        // AI ì¶”ì²œ ì£¼ì œ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadTopics() {
            const grid = document.getElementById('topicsGrid');

            try {
                const snapshot = await db.collection('topics').orderBy('potential').limit(10).get();

                if (snapshot.empty) {
                    // Firestoreì— ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    await getNewTopics();
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const potentialClass = data.potential === 'ìƒ' ? 'tag-high' : 'tag-medium';
                    html += `
                        <div class="topic-card p-4 border-2 border-gray-200 rounded-xl" onclick="selectTopic('${data.title}', '${data.category}')">
                            <div class="flex justify-between items-start mb-2">
                                <span class="tag ${potentialClass}">ì¡°íšŒìˆ˜ ${data.potential}</span>
                                <span class="text-gray-400 text-sm">${data.category || ''}</span>
                            </div>
                            <p class="font-medium text-gray-800">${data.title}</p>
                        </div>
                    `;
                });
                grid.innerHTML = html;
            } catch (error) {
                console.error('Error loading topics:', error);
                grid.innerHTML = '<p class="text-red-500 col-span-2 text-center py-4">ì£¼ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>';
            }
        }

        // ìƒˆë¡œìš´ ì¶”ì²œ ì£¼ì œ ìƒì„±
        async function getNewTopics() {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = `
                <div class="loading text-center py-8 col-span-2">
                    <div class="text-4xl mb-2">ğŸ¤–</div>
                    <p class="text-gray-500">AIê°€ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ì¶”ì²œí•˜ê³  ìˆì–´ìš”...</p>
                </div>
            `;

            const prompt = `ìœ íŠœë¸Œì—ì„œ ì¡°íšŒìˆ˜ê°€ ì˜ ë‚˜ì˜¤ëŠ” ì§€ì‹/ì •ë³´ ì½˜í…ì¸  ì£¼ì œ 10ê°œë¥¼ ì¶”ì²œí•´ì¤˜.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´:
{
  "topics": [
    {"title": "ì£¼ì œ ì œëª©", "category": "ì¹´í…Œê³ ë¦¬", "potential": "ìƒ/ì¤‘ìƒ/ì¤‘"}
  ]
}

ì¡°ê±´:
- í•œêµ­ ì‹œì²­ì ëŒ€ìƒ
- í¥ë¯¸ë¥¼ ìœ ë°œí•˜ëŠ” ì œëª©
- ì¹´í…Œê³ ë¦¬: ê¸°ìˆ /AI, ì¬í…Œí¬, ì—­ì‚¬, ê³¼í•™, ë¯¸ìŠ¤í„°ë¦¬, ê±´ê°•, ì‹¬ë¦¬í•™ ì¤‘ íƒ1
- potentialì€ ì˜ˆìƒ ì¡°íšŒìˆ˜ ì ì¬ë ¥`;

            try {
                const result = await callGeminiAPI(prompt, { temperature: 0.9 });

                if (!result.success) {
                    throw new Error(result.error);
                }

                let text = result.data.candidates[0].content.parts[0].text;

                // JSON ì¶”ì¶œ
                if (text.includes('```json')) {
                    text = text.split('```json')[1].split('```')[0];
                } else if (text.includes('```')) {
                    text = text.split('```')[1].split('```')[0];
                }

                const parsedData = JSON.parse(text.trim());

                // Firestoreì— ì €ì¥
                const batch = db.batch();

                // ê¸°ì¡´ topics ì‚­ì œ
                const existing = await db.collection('topics').get();
                existing.forEach(doc => batch.delete(doc.ref));

                // ìƒˆ topics ì¶”ê°€
                parsedData.topics.forEach(topic => {
                    const ref = db.collection('topics').doc();
                    batch.set(ref, {
                        ...topic,
                        type: 'ai_recommended',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();
                await loadTopics();

            } catch (error) {
                console.error('Error generating topics:', error);
                grid.innerHTML = '<p class="text-red-500 col-span-2 text-center py-4">ì£¼ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
            }
        }

        // ì£¼ì œ ì„ íƒ
        function selectTopic(title, category) {
            selectedTopic = { title, category };

            // ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
                if (card.querySelector('p').textContent === title) {
                    card.classList.add('selected');
                }
            });

            // ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
            const categoryMap = {
                'ê¸°ìˆ /AI': 'technology',
                'ì¬í…Œí¬': 'finance',
                'ì—­ì‚¬': 'history',
                'ê³¼í•™': 'science',
                'ë¯¸ìŠ¤í„°ë¦¬': 'mystery',
                'ê±´ê°•': 'health',
                'ì‹¬ë¦¬í•™': 'lifestyle'
            };
            if (categoryMap[category]) {
                document.getElementById('category').value = categoryMap[category];
            }

            goToStep(2);
        }

        // ì§ì ‘ ì…ë ¥ ì£¼ì œ ì„ íƒ
        function selectCustomTopic() {
            const input = document.getElementById('customTopic');
            if (input.value.trim()) {
                selectedTopic = { title: input.value.trim(), category: '' };
                goToStep(2);
            }
        }

        // ë‹¨ê³„ ì´ë™
        function goToStep(step) {
            currentStep = step;

            // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            document.getElementById('section1').classList.toggle('hidden', step !== 1);
            document.getElementById('section2').classList.toggle('hidden', step !== 2);
            document.getElementById('section3').classList.toggle('hidden', step !== 3);

            // ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed', 'inactive');
                if (i < step) stepEl.classList.add('completed');
                else if (i === step) stepEl.classList.add('active');
                else stepEl.classList.add('inactive');
            }

            // ì„ íƒëœ ì£¼ì œ í‘œì‹œ
            if (step === 2 && selectedTopic) {
                document.getElementById('selectedTopicDisplay').textContent = selectedTopic.title;
            }

            // ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        async function generateScript() {
            goToStep(3);

            document.getElementById('generatingStatus').classList.remove('hidden');
            document.getElementById('scriptResult').classList.add('hidden');

            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.getElementById('progressFill').style.width = progress + '%';
            }, 500);

            const settings = {
                topic: selectedTopic.title,
                category: document.getElementById('category').value,
                style: document.getElementById('style').value,
                duration: parseInt(document.getElementById('duration').value),
                language: document.getElementById('language').value
            };

            const styleGuides = {
                kurzgesagt: "ìš°ì£¼ì  ê´€ì , ì² í•™ì  í†¤, ì‹œê°ì  ì€ìœ  ì‚¬ìš©",
                knowledge_pirate: "ì¹œê·¼í•˜ê³  ì¬ë¯¸ìˆëŠ” ì„¤ëª…, êµ¬ì–´ì²´",
                veritasium: "íƒêµ¬ì , ì§ˆë¬¸í˜•, ì¼ë°˜ì  ì˜¤í•´ ë°”ë¡œì¡ê¸°",
                infographic: "ë°ì´í„° ì¤‘ì‹¬, ëª…í™•í•œ êµ¬ë¶„, ë¦¬ìŠ¤íŠ¸ í™œìš©"
            };

            const prompt = `ìœ íŠœë¸Œ ì§€ì‹ ì±„ë„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜.

ì£¼ì œ: ${settings.topic}
ì¹´í…Œê³ ë¦¬: ${settings.category}
ìŠ¤íƒ€ì¼: ${styleGuides[settings.style]}
ëª©í‘œ ê¸¸ì´: ${settings.duration}ì´ˆ (ì•½ ${Math.floor(settings.duration/60)}ë¶„)
ì–¸ì–´: ${settings.language === 'ko' ? 'í•œêµ­ì–´' : settings.language === 'en' ? 'English' : 'æ—¥æœ¬èª'}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´:
{
  "titles": ["ì¶”ì²œ ì œëª© 1", "ì¶”ì²œ ì œëª© 2", "ì¶”ì²œ ì œëª© 3"],
  "hooks": ["ì‹œì‘ í›„í¬ ë©˜íŠ¸ 1", "ì‹œì‘ í›„í¬ ë©˜íŠ¸ 2"],
  "full_script": "ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©...",
  "key_points": ["í•µì‹¬ í¬ì¸íŠ¸ 1", "í•µì‹¬ í¬ì¸íŠ¸ 2", "í•µì‹¬ í¬ì¸íŠ¸ 3"],
  "cta": "êµ¬ë…/ì¢‹ì•„ìš” ìœ ë„ ë©˜íŠ¸"
}

ìŠ¤í¬ë¦½íŠ¸ ìš”êµ¬ì‚¬í•­:
1. ì²˜ìŒ 15ì´ˆì— ê°•ë ¥í•œ í›„í¬ (ì¶©ê²©ì  ì‚¬ì‹¤ì´ë‚˜ ì§ˆë¬¸)
2. êµ¬ì–´ì²´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ
3. ê° ì„¹ì…˜ ëª…í™•íˆ êµ¬ë¶„
4. ê²°ë¡ ì—ì„œ CTA í¬í•¨`;

            try {
                const result = await callGeminiAPI(prompt, { temperature: 0.7, maxTokens: 8000 });

                clearInterval(progressInterval);
                document.getElementById('progressFill').style.width = '100%';

                if (!result.success) {
                    throw new Error(result.error);
                }

                console.log(`Success with model: ${result.model}`);
                let text = result.data.candidates[0].content.parts[0].text;

                if (text.includes('```json')) {
                    text = text.split('```json')[1].split('```')[0];
                } else if (text.includes('```')) {
                    text = text.split('```')[1].split('```')[0];
                }

                currentScript = JSON.parse(text.trim());
                currentScript.settings = settings;
                currentScript.model = result.model;

                // ê²°ê³¼ í‘œì‹œ
                displayScriptResult();

            } catch (error) {
                console.error('Error generating script:', error);
                clearInterval(progressInterval);
                document.getElementById('generatingStatus').innerHTML = `
                    <div class="text-red-500 text-center">
                        <div class="text-6xl mb-4">âŒ</div>
                        <p class="text-xl font-medium">ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
                        <p class="mt-2">${error.message}</p>
                        <button onclick="generateScript()" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayScriptResult() {
            document.getElementById('generatingStatus').classList.add('hidden');
            document.getElementById('scriptResult').classList.remove('hidden');

            // ì¶”ì²œ ì œëª©
            const titlesHtml = currentScript.titles.map(t =>
                `<div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="copyText('${t.replace(/'/g, "\\'")}')">
                    ğŸ“Œ ${t}
                </div>`
            ).join('');
            document.getElementById('suggestedTitles').innerHTML = titlesHtml;

            // í›„í¬
            document.getElementById('hooks').innerHTML = currentScript.hooks.map(h => `<p class="mb-2">ğŸ¯ "${h}"</p>`).join('');

            // ì „ì²´ ìŠ¤í¬ë¦½íŠ¸
            document.getElementById('fullScript').textContent = currentScript.full_script;

            // í•µì‹¬ í¬ì¸íŠ¸
            const pointsHtml = currentScript.key_points.map(p =>
                `<div class="flex items-start gap-2"><span class="text-purple-600">âœ“</span><span>${p}</span></div>`
            ).join('');
            document.getElementById('keyPoints').innerHTML = pointsHtml;
        }

        // ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
        function copyScript() {
            navigator.clipboard.writeText(currentScript.full_script);
            alert('ìŠ¤í¬ë¦½íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í…ìŠ¤íŠ¸ ë³µì‚¬
        function copyText(text) {
            navigator.clipboard.writeText(text);
            alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í”„ë¡œì íŠ¸ ì €ì¥
        async function saveProject() {
            try {
                await db.collection('projects').add({
                    topic: currentScript.settings.topic,
                    category: currentScript.settings.category,
                    style: currentScript.settings.style,
                    titles: currentScript.titles,
                    script: currentScript.full_script,
                    hooks: currentScript.hooks,
                    key_points: currentScript.key_points,
                    status: 'script_complete',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadRecentProjects();
            } catch (error) {
                console.error('Error saving project:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ìµœê·¼ í”„ë¡œì íŠ¸ ë¡œë“œ
        async function loadRecentProjects() {
            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();

                const container = document.getElementById('recentProjects');

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('ko-KR') : '';
                    html += `
                        <div class="p-4 bg-gray-50 rounded-xl hover:bg-gray-100 cursor-pointer" onclick="loadProject('${doc.id}')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-gray-800">${data.topic || 'Untitled'}</p>
                                    <p class="text-sm text-gray-500">${data.category || ''} â€¢ ${date}</p>
                                </div>
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">${data.status || 'saved'}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // í”„ë¡œì íŠ¸ ë¡œë“œ
        async function loadProject(projectId) {
            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    const data = doc.data();
                    currentScript = {
                        titles: data.titles || [data.topic],
                        hooks: data.hooks || [],
                        full_script: data.script || '',
                        key_points: data.key_points || [],
                        settings: { topic: data.topic, category: data.category, style: data.style }
                    };
                    selectedTopic = { title: data.topic, category: data.category };
                    goToStep(3);
                    displayScriptResult();
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }

        // ì²˜ìŒë¶€í„° ë‹¤ì‹œ
        function startOver() {
            selectedTopic = null;
            currentScript = null;
            document.getElementById('customTopic').value = '';
            document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('selected'));
            goToStep(1);
        }
    </script>
</body>
</html>
