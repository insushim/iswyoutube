<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìœ íŠœë¸Œ ì˜ìƒ ìƒì„±ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .topic-card { transition: all 0.3s; cursor: pointer; }
        .topic-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .topic-card.selected { border: 3px solid #667eea; background: #f0f4ff; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tag-high { background: #dcfce7; color: #166534; }
        .tag-medium { background: #fef9c3; color: #854d0e; }
        .step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .step { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .step.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .step.completed { background: #22c55e; color: white; }
        .step.inactive { background: #e5e7eb; color: #9ca3af; }
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <span class="text-4xl">ğŸ¬</span> AI ìœ íŠœë¸Œ ì˜ìƒ ìƒì„±ê¸°
                </h1>
                <p class="text-purple-200 mt-1">í´ë¦­ ëª‡ ë²ˆìœ¼ë¡œ ìœ íŠœë¸Œ ì˜ìƒ ì™„ì„±!</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-purple-200">Powered by</p>
                <p class="font-bold">Gemini 3 Flash</p>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto py-8 px-4">
        <!-- Step Indicator -->
        <div class="step-indicator mb-8">
            <div class="step active" id="step1">1</div>
            <div class="w-16 h-1 bg-gray-300 self-center rounded" id="line1"></div>
            <div class="step inactive" id="step2">2</div>
            <div class="w-16 h-1 bg-gray-300 self-center rounded" id="line2"></div>
            <div class="step inactive" id="step3">3</div>
        </div>

        <!-- Step 1: ì£¼ì œ ì„ íƒ -->
        <section id="section1" class="fade-in">
            <div class="card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-3xl">ğŸ’¡</span> AI ì¶”ì²œ ì£¼ì œ
                    </h2>
                    <button onclick="getNewTopics()" class="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition">
                        <span>ğŸ”„</span> ìƒˆë¡œìš´ ì¶”ì²œ
                    </button>
                </div>
                <p class="text-gray-600 mb-4">ì¡°íšŒìˆ˜ê°€ ì˜ ë‚˜ì˜¤ëŠ” ì£¼ì œë¥¼ AIê°€ ì¶”ì²œí•´ë“œë ¤ìš”. í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”!</p>

                <div id="topicsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Topics will be loaded here -->
                    <div class="loading text-center py-8 col-span-2">
                        <div class="text-4xl mb-2">ğŸ¤–</div>
                        <p class="text-gray-500">AI ì¶”ì²œ ì£¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- ì§ì ‘ ì…ë ¥ -->
            <div class="card p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>âœï¸</span> ë˜ëŠ” ì§ì ‘ ì…ë ¥
                </h3>
                <div class="flex gap-4">
                    <input type="text" id="customTopic" placeholder="ì›í•˜ëŠ” ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">
                    <button onclick="selectCustomTopic()" class="btn-primary text-white px-6 py-3 rounded-xl font-medium transition">
                        ì„ íƒ
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: ì„¤ì • -->
        <section id="section2" class="hidden fade-in">
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="text-3xl">âš™ï¸</span> ì˜ìƒ ì„¤ì •
                </h2>

                <div class="bg-purple-50 p-4 rounded-xl mb-6">
                    <p class="text-sm text-purple-600 mb-1">ì„ íƒëœ ì£¼ì œ</p>
                    <p class="text-xl font-bold text-gray-800" id="selectedTopicDisplay"></p>
                </div>

                <!-- ì‹œë¦¬ì¦ˆ ëª¨ë“œ ì„ íƒ -->
                <div class="mb-6 p-4 border-2 border-dashed border-purple-300 rounded-xl bg-purple-50">
                    <div class="flex items-center gap-4 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="videoMode" value="single" checked onchange="toggleSeriesMode()" class="w-5 h-5 text-purple-600">
                            <span class="font-medium">ğŸ¬ ë‹¨ì¼ ì˜ìƒ</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="videoMode" value="series" onchange="toggleSeriesMode()" class="w-5 h-5 text-purple-600">
                            <span class="font-medium">ğŸ“š ì‹œë¦¬ì¦ˆë¬¼</span>
                        </label>
                    </div>

                    <!-- ì‹œë¦¬ì¦ˆ ì„¤ì • (ê¸°ë³¸ ìˆ¨ê¹€) -->
                    <div id="seriesSettings" class="hidden mt-4 p-4 bg-white rounded-lg">
                        <h4 class="font-bold text-purple-800 mb-3 flex items-center gap-2">
                            <span>ğŸ“š</span> ì‹œë¦¬ì¦ˆ ì„¤ì •
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì—í”¼ì†Œë“œ ìˆ˜</label>
                                <select id="episodeCount" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                                    <option value="3">3í¸ (ë¯¸ë‹ˆ ì‹œë¦¬ì¦ˆ)</option>
                                    <option value="5" selected>5í¸ (í‘œì¤€)</option>
                                    <option value="7">7í¸</option>
                                    <option value="10">10í¸ (ì¥í¸)</option>
                                    <option value="15">15í¸ (ëŒ€ì‘)</option>
                                    <option value="20">20í¸ (ì´ˆëŒ€ì‘) â­ìµœëŒ€</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œë¦¬ì¦ˆ í˜•ì‹</label>
                                <select id="seriesFormat" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                                    <option value="chronological">ğŸ“… ì‹œê°„ìˆœ (ì—­ì‚¬/ì‚¬ê±´)</option>
                                    <option value="thematic">ğŸ¯ ì£¼ì œë³„ (ì¹´í…Œê³ ë¦¬)</option>
                                    <option value="ranking">ğŸ† ë­í‚¹í˜• (TOP N)</option>
                                    <option value="mystery">ğŸ” ë¯¸ìŠ¤í„°ë¦¬ (ì ì§„ì  ê³µê°œ)</option>
                                    <option value="comparison">âš”ï¸ ë¹„êµí˜• (VS/ëŒ€ê²°)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œë¦¬ì¦ˆ ì œëª© (ì„ íƒ)</label>
                            <input type="text" id="seriesTitle" placeholder="ì˜ˆ: ì¡°ì„ ì™•ì¡° ë¯¸ìŠ¤í„°ë¦¬, ì„¸ê³„ëŒ€ì „ ë¹„í•˜ì¸ë“œ..."
                                   class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        </div>
                        <p class="text-sm text-purple-600 mt-3">ğŸ’¡ AIê°€ ì „ì²´ ì‹œë¦¬ì¦ˆ êµ¬ì„±ê³¼ ê° ì—í”¼ì†Œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤!</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ì¹´í…Œê³ ë¦¬</label>
                        <select id="category" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="technology">ğŸ¤– ê¸°ìˆ /AI</option>
                            <option value="finance">ğŸ’° ì¬í…Œí¬/ê²½ì œ</option>
                            <option value="history">ğŸ“œ ì—­ì‚¬</option>
                            <option value="science">ğŸ”¬ ê³¼í•™</option>
                            <option value="mystery">ğŸ”® ë¯¸ìŠ¤í„°ë¦¬</option>
                            <option value="health">ğŸ’ª ê±´ê°•</option>
                            <option value="lifestyle">ğŸŒŸ ë¼ì´í”„ìŠ¤íƒ€ì¼</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¨ ì˜ìƒ ìŠ¤íƒ€ì¼</label>
                        <select id="style" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="kurzgesagt">ğŸŒŒ Kurzgesagt (ìš°ì£¼ì  ê´€ì )</option>
                            <option value="knowledge_pirate">ğŸ´â€â˜ ï¸ ì§€ì‹í•´ì ë‹¨ (ì¹œê·¼í•œ ì„¤ëª…)</option>
                            <option value="veritasium">ğŸ” Veritasium (íƒêµ¬í˜•)</option>
                            <option value="infographic">ğŸ“Š ì¸í¬ê·¸ë˜í”½ (ë°ì´í„° ì¤‘ì‹¬)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">â±ï¸ ì˜ìƒ ê¸¸ì´</label>
                        <select id="duration" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="300">5ë¶„ (ìˆí¼)</option>
                            <option value="600" selected>10ë¶„ (í‘œì¤€)</option>
                            <option value="900">15ë¶„ (ê¸´ ì˜ìƒ)</option>
                            <option value="1200">20ë¶„ (ì‹¬ì¸µ ë¶„ì„)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ ì–¸ì–´</label>
                        <select id="language" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                            <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-4 mt-8">
                    <button onclick="goToStep(1)" class="px-6 py-3 border-2 border-gray-300 rounded-xl font-medium hover:bg-gray-100 transition">
                        â† ì´ì „
                    </button>
                    <button onclick="generateContent()" id="generateBtn" class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium transition flex items-center justify-center gap-2">
                        <span>ğŸš€</span> <span id="generateBtnText">ìŠ¤í¬ë¦½íŠ¸ ìƒì„±í•˜ê¸°</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 3: ê²°ê³¼ -->
        <section id="section3" class="hidden fade-in">
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="text-3xl">ğŸ“</span> ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸
                </h2>

                <div id="generatingStatus" class="text-center py-12">
                    <div class="text-6xl mb-4 loading">ğŸ¤–</div>
                    <p class="text-xl font-medium text-gray-700">AIê°€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ê³  ìˆì–´ìš”...</p>
                    <p class="text-gray-500 mt-2">ì•½ 30ì´ˆ~1ë¶„ ì •ë„ ê±¸ë¦½ë‹ˆë‹¤</p>
                    <div class="progress-bar w-64 mx-auto mt-4">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- ì‹œë¦¬ì¦ˆ ê²°ê³¼ -->
                <div id="seriesResult" class="hidden">
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-4 mb-6">
                        <p class="text-purple-700 font-medium flex items-center gap-2">
                            <span class="text-xl">ğŸ“š</span> <span id="seriesSuccessMsg">ì‹œë¦¬ì¦ˆê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                        </p>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-xl mb-3 flex items-center gap-2">ğŸ“š ì‹œë¦¬ì¦ˆ ê°œìš”</h3>
                        <div id="seriesOverview" class="bg-white p-4 rounded-xl border"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-xl mb-4 flex items-center gap-2">ğŸ¬ ì—í”¼ì†Œë“œ ëª©ë¡</h3>
                        <div id="episodeList" class="space-y-4"></div>
                    </div>

                    <div class="flex gap-4 mb-6">
                        <button onclick="downloadSeriesAll()" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-medium hover:opacity-90 transition flex items-center justify-center gap-2">
                            <span>ğŸ“¦</span> ì „ì²´ ì‹œë¦¬ì¦ˆ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button onclick="saveSeriesProject()" class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium transition flex items-center justify-center gap-2">
                            <span>ğŸ’¾</span> ì‹œë¦¬ì¦ˆ ì €ì¥
                        </button>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <button onclick="startOver()" class="w-full px-6 py-3 border-2 border-purple-300 text-purple-700 rounded-xl font-medium hover:bg-purple-50 transition">
                            ğŸ”„ ìƒˆë¡œìš´ ì‹œë¦¬ì¦ˆ ë§Œë“¤ê¸°
                        </button>
                    </div>
                </div>

                <div id="scriptResult" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                        <p class="text-green-700 font-medium flex items-center gap-2">
                            <span class="text-xl">âœ…</span> ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
                        </p>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ¯ ì¶”ì²œ ì œëª©</h3>
                        <div id="suggestedTitles" class="space-y-2"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ¬ ì˜¤í”„ë‹ í›„í¬</h3>
                        <div id="hooks" class="bg-yellow-50 p-4 rounded-xl"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ“œ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸</h3>
                        <div id="fullScript" class="bg-gray-50 p-4 rounded-xl whitespace-pre-wrap text-gray-700 max-h-96 overflow-y-auto"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸</h3>
                        <div id="keyPoints" class="space-y-2"></div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="copyScript()" class="flex-1 px-6 py-3 bg-gray-100 rounded-xl font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2">
                            <span>ğŸ“‹</span> ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
                        </button>
                        <button onclick="saveProject()" class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium transition flex items-center justify-center gap-2">
                            <span>ğŸ’¾</span> í”„ë¡œì íŠ¸ ì €ì¥
                        </button>
                    </div>

                    <!-- ì˜ìƒ ì œì‘ ë„êµ¬ -->
                    <div class="mt-8 pt-6 border-t">
                        <h3 class="font-bold text-xl mb-4 flex items-center gap-2">ğŸ¬ ì˜ìƒ ì œì‘ ë„êµ¬</h3>

                        <!-- Step 4: ìŒì„± ìƒì„± -->
                        <div class="bg-blue-50 rounded-xl p-4 mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium text-blue-800 flex items-center gap-2">
                                    <span>ğŸ”Š</span> Step 1: ìŒì„±(TTS) ìƒì„±
                                </h4>
                                <select id="ttsVoice" class="px-3 py-1 border rounded-lg text-sm">
                                    <option value="ko-KR">í•œêµ­ì–´ (ê¸°ë³¸)</option>
                                    <option value="ko-KR-female">í•œêµ­ì–´ (ì—¬ì„±)</option>
                                    <option value="en-US">English</option>
                                </select>
                            </div>
                            <p class="text-sm text-blue-600 mb-3">ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìŒì„± íŒŒì¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤</p>
                            <div class="flex gap-2">
                                <button onclick="generateTTS()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                    <span>â–¶ï¸</span> ìŒì„± ë¯¸ë¦¬ë“£ê¸°
                                </button>
                                <button onclick="downloadTTS()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">
                                    ğŸ’¾ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                            <div id="ttsStatus" class="mt-2 text-sm text-blue-600 hidden"></div>
                            <audio id="ttsAudio" class="w-full mt-2 hidden" controls></audio>
                        </div>

                        <!-- Step 5: ì´ë¯¸ì§€ ê²€ìƒ‰ -->
                        <div class="bg-green-50 rounded-xl p-4 mb-4">
                            <h4 class="font-medium text-green-800 mb-3 flex items-center gap-2">
                                <span>ğŸ–¼ï¸</span> Step 2: ì´ë¯¸ì§€ ì¤€ë¹„
                            </h4>
                            <p class="text-sm text-green-600 mb-3">ì£¼ì œì— ë§ëŠ” ë¬´ë£Œ ì´ë¯¸ì§€ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤</p>
                            <div id="imageKeywords" class="flex flex-wrap gap-2 mb-3"></div>
                            <button onclick="searchImages()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <span>ğŸ”</span> Unsplashì—ì„œ ì´ë¯¸ì§€ ê²€ìƒ‰
                            </button>
                            <div id="imageResults" class="grid grid-cols-3 gap-2 mt-3 hidden"></div>
                        </div>

                        <!-- Step 6: ì˜ìƒ í¸ì§‘ ê°€ì´ë“œ -->
                        <div class="bg-purple-50 rounded-xl p-4 mb-4">
                            <h4 class="font-medium text-purple-800 mb-3 flex items-center gap-2">
                                <span>ğŸ¥</span> Step 3: ì˜ìƒ í¸ì§‘
                            </h4>
                            <p class="text-sm text-purple-600 mb-3">ì•„ë˜ ë„êµ¬ë¡œ ì˜ìƒì„ ë§Œë“œì„¸ìš”</p>
                            <div class="grid grid-cols-2 gap-2">
                                <a href="https://www.canva.com/video-editor/" target="_blank" class="p-3 bg-white rounded-lg text-center hover:shadow-md transition">
                                    <div class="text-2xl mb-1">ğŸ¨</div>
                                    <div class="text-sm font-medium">Canva</div>
                                    <div class="text-xs text-gray-500">ë¬´ë£Œ, ì´ˆë³´ììš©</div>
                                </a>
                                <a href="https://www.capcut.com/" target="_blank" class="p-3 bg-white rounded-lg text-center hover:shadow-md transition">
                                    <div class="text-2xl mb-1">âœ‚ï¸</div>
                                    <div class="text-sm font-medium">CapCut</div>
                                    <div class="text-xs text-gray-500">ë¬´ë£Œ, AI ê¸°ëŠ¥</div>
                                </a>
                                <a href="https://clipchamp.com/" target="_blank" class="p-3 bg-white rounded-lg text-center hover:shadow-md transition">
                                    <div class="text-2xl mb-1">ğŸ¬</div>
                                    <div class="text-sm font-medium">Clipchamp</div>
                                    <div class="text-xs text-gray-500">MS ë¬´ë£Œ</div>
                                </a>
                                <a href="https://www.veed.io/" target="_blank" class="p-3 bg-white rounded-lg text-center hover:shadow-md transition">
                                    <div class="text-2xl mb-1">âš¡</div>
                                    <div class="text-sm font-medium">VEED</div>
                                    <div class="text-xs text-gray-500">ì›¹ ê¸°ë°˜</div>
                                </a>
                            </div>
                        </div>

                        <!-- ì „ì²´ ë‹¤ìš´ë¡œë“œ -->
                        <button onclick="downloadAll()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-medium hover:opacity-90 transition flex items-center justify-center gap-2">
                            <span>ğŸ“¦</span> ì „ì²´ ìë£Œ ë‹¤ìš´ë¡œë“œ (ìŠ¤í¬ë¦½íŠ¸ + ì´ë¯¸ì§€ ë§í¬)
                        </button>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <button onclick="startOver()" class="w-full px-6 py-3 border-2 border-purple-300 text-purple-700 rounded-xl font-medium hover:bg-purple-50 transition">
                            ğŸ”„ ìƒˆë¡œìš´ ì˜ìƒ ë§Œë“¤ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ìµœê·¼ í”„ë¡œì íŠ¸ -->
        <section class="card p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“‚</span> ìµœê·¼ í”„ë¡œì íŠ¸
            </h2>
            <div id="recentProjects" class="space-y-3">
                <p class="text-gray-500 text-center py-4">ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p>AI ìœ íŠœë¸Œ ì˜ìƒ ìƒì„±ê¸° v2.0</p>
            <p class="text-sm mt-1">Firebase + Gemini 3 Flash</p>
        </div>
    </footer>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyC6sH9sNQs7rCuau0m0u3mwG9p9p4kfYOA",
            authDomain: "tts-pro-80ebc.firebaseapp.com",
            projectId: "tts-pro-80ebc",
            storageBucket: "tts-pro-80ebc.firebasestorage.app",
            messagingSenderId: "567421649132",
            appId: "1:567421649132:web:5f5d04c501b0bec26125c9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Gemini API í‚¤
        const GEMINI_API_KEY = "AIzaSyAzBMnwglsb6x8bAI-dU5h4lkM4TUEvjAo";

        // ìƒíƒœ ê´€ë¦¬
        let selectedTopic = null;
        let currentScript = null;
        let currentSeries = null;
        let currentStep = 1;
        let isSeriesMode = false;

        // ì‹œë¦¬ì¦ˆ ëª¨ë“œ í† ê¸€
        function toggleSeriesMode() {
            isSeriesMode = document.querySelector('input[name="videoMode"]:checked').value === 'series';
            document.getElementById('seriesSettings').classList.toggle('hidden', !isSeriesMode);
            document.getElementById('generateBtnText').textContent = isSeriesMode ? 'ì‹œë¦¬ì¦ˆ ìƒì„±í•˜ê¸°' : 'ìŠ¤í¬ë¦½íŠ¸ ìƒì„±í•˜ê¸°';
        }

        // ì½˜í…ì¸  ìƒì„± (ë‹¨ì¼/ì‹œë¦¬ì¦ˆ ë¶„ê¸°)
        function generateContent() {
            if (isSeriesMode) {
                generateSeries();
            } else {
                generateScript();
            }
        }

        // Gemini API í˜¸ì¶œ (ìë™ ëª¨ë¸ ì „í™˜)
        async function callGeminiAPI(prompt, config = {}) {
            const models = ['gemini-3-flash-preview'];

            for (const model of models) {
                try {
                    console.log(`Trying model: ${model}`);
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: config.temperature || 0.7, maxOutputTokens: config.maxTokens || 8000 }
                        })
                    });

                    const data = await response.json();
                    console.log(`${model} response:`, data);

                    if (data.candidates && data.candidates[0]) {
                        return { success: true, data, model };
                    }

                    if (data.error?.message?.includes('overloaded')) {
                        console.log(`${model} is overloaded, trying next model...`);
                        continue;
                    }

                    console.log(`${model} failed:`, data.error?.message);
                } catch (e) {
                    console.log(`${model} error:`, e);
                }
            }

            return { success: false, error: 'ëª¨ë“  ëª¨ë¸ì´ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', () => {
            loadTopics();
            loadRecentProjects();
        });

        // AI ì¶”ì²œ ì£¼ì œ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadTopics() {
            const grid = document.getElementById('topicsGrid');

            try {
                const snapshot = await db.collection('topics').orderBy('potential').limit(10).get();

                if (snapshot.empty) {
                    // Firestoreì— ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    await getNewTopics();
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const potentialClass = data.potential === 'ìƒ' ? 'tag-high' : 'tag-medium';
                    html += `
                        <div class="topic-card p-4 border-2 border-gray-200 rounded-xl" onclick="selectTopic('${data.title}', '${data.category}')">
                            <div class="flex justify-between items-start mb-2">
                                <span class="tag ${potentialClass}">ì¡°íšŒìˆ˜ ${data.potential}</span>
                                <span class="text-gray-400 text-sm">${data.category || ''}</span>
                            </div>
                            <p class="font-medium text-gray-800">${data.title}</p>
                        </div>
                    `;
                });
                grid.innerHTML = html;
            } catch (error) {
                console.error('Error loading topics:', error);
                grid.innerHTML = '<p class="text-red-500 col-span-2 text-center py-4">ì£¼ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>';
            }
        }

        // ìƒˆë¡œìš´ ì¶”ì²œ ì£¼ì œ ìƒì„±
        async function getNewTopics() {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = `
                <div class="loading text-center py-8 col-span-2">
                    <div class="text-4xl mb-2">ğŸ¤–</div>
                    <p class="text-gray-500">AIê°€ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ì¶”ì²œí•˜ê³  ìˆì–´ìš”...</p>
                </div>
            `;

            const prompt = `ìœ íŠœë¸Œì—ì„œ ì¡°íšŒìˆ˜ê°€ ì˜ ë‚˜ì˜¤ëŠ” ì§€ì‹/ì •ë³´ ì½˜í…ì¸  ì£¼ì œ 10ê°œë¥¼ ì¶”ì²œí•´ì¤˜.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´:
{
  "topics": [
    {"title": "ì£¼ì œ ì œëª©", "category": "ì¹´í…Œê³ ë¦¬", "potential": "ìƒ/ì¤‘ìƒ/ì¤‘"}
  ]
}

ì¡°ê±´:
- í•œêµ­ ì‹œì²­ì ëŒ€ìƒ
- í¥ë¯¸ë¥¼ ìœ ë°œí•˜ëŠ” ì œëª©
- ì¹´í…Œê³ ë¦¬: ê¸°ìˆ /AI, ì¬í…Œí¬, ì—­ì‚¬, ê³¼í•™, ë¯¸ìŠ¤í„°ë¦¬, ê±´ê°•, ì‹¬ë¦¬í•™ ì¤‘ íƒ1
- potentialì€ ì˜ˆìƒ ì¡°íšŒìˆ˜ ì ì¬ë ¥`;

            try {
                const result = await callGeminiAPI(prompt, { temperature: 0.9 });

                if (!result.success) {
                    throw new Error(result.error);
                }

                let text = result.data.candidates[0].content.parts[0].text;

                // JSON ì¶”ì¶œ
                if (text.includes('```json')) {
                    text = text.split('```json')[1].split('```')[0];
                } else if (text.includes('```')) {
                    text = text.split('```')[1].split('```')[0];
                }

                const parsedData = JSON.parse(text.trim());

                // Firestoreì— ì €ì¥
                const batch = db.batch();

                // ê¸°ì¡´ topics ì‚­ì œ
                const existing = await db.collection('topics').get();
                existing.forEach(doc => batch.delete(doc.ref));

                // ìƒˆ topics ì¶”ê°€
                parsedData.topics.forEach(topic => {
                    const ref = db.collection('topics').doc();
                    batch.set(ref, {
                        ...topic,
                        type: 'ai_recommended',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();
                await loadTopics();

            } catch (error) {
                console.error('Error generating topics:', error);
                grid.innerHTML = '<p class="text-red-500 col-span-2 text-center py-4">ì£¼ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
            }
        }

        // ì£¼ì œ ì„ íƒ
        function selectTopic(title, category) {
            selectedTopic = { title, category };

            // ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
                if (card.querySelector('p').textContent === title) {
                    card.classList.add('selected');
                }
            });

            // ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ
            const categoryMap = {
                'ê¸°ìˆ /AI': 'technology',
                'ì¬í…Œí¬': 'finance',
                'ì—­ì‚¬': 'history',
                'ê³¼í•™': 'science',
                'ë¯¸ìŠ¤í„°ë¦¬': 'mystery',
                'ê±´ê°•': 'health',
                'ì‹¬ë¦¬í•™': 'lifestyle'
            };
            if (categoryMap[category]) {
                document.getElementById('category').value = categoryMap[category];
            }

            goToStep(2);
        }

        // ì§ì ‘ ì…ë ¥ ì£¼ì œ ì„ íƒ
        function selectCustomTopic() {
            const input = document.getElementById('customTopic');
            if (input.value.trim()) {
                selectedTopic = { title: input.value.trim(), category: '' };
                goToStep(2);
            }
        }

        // ë‹¨ê³„ ì´ë™
        function goToStep(step) {
            currentStep = step;

            // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            document.getElementById('section1').classList.toggle('hidden', step !== 1);
            document.getElementById('section2').classList.toggle('hidden', step !== 2);
            document.getElementById('section3').classList.toggle('hidden', step !== 3);

            // ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed', 'inactive');
                if (i < step) stepEl.classList.add('completed');
                else if (i === step) stepEl.classList.add('active');
                else stepEl.classList.add('inactive');
            }

            // ì„ íƒëœ ì£¼ì œ í‘œì‹œ
            if (step === 2 && selectedTopic) {
                document.getElementById('selectedTopicDisplay').textContent = selectedTopic.title;
            }

            // ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        async function generateScript() {
            goToStep(3);

            document.getElementById('generatingStatus').classList.remove('hidden');
            document.getElementById('scriptResult').classList.add('hidden');

            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.getElementById('progressFill').style.width = progress + '%';
            }, 500);

            const settings = {
                topic: selectedTopic.title,
                category: document.getElementById('category').value,
                style: document.getElementById('style').value,
                duration: parseInt(document.getElementById('duration').value),
                language: document.getElementById('language').value
            };

            const styleGuides = {
                kurzgesagt: "ìš°ì£¼ì  ê´€ì , ì² í•™ì  í†¤, ì‹œê°ì  ì€ìœ  ì‚¬ìš©",
                knowledge_pirate: "ì¹œê·¼í•˜ê³  ì¬ë¯¸ìˆëŠ” ì„¤ëª…, êµ¬ì–´ì²´",
                veritasium: "íƒêµ¬ì , ì§ˆë¬¸í˜•, ì¼ë°˜ì  ì˜¤í•´ ë°”ë¡œì¡ê¸°",
                infographic: "ë°ì´í„° ì¤‘ì‹¬, ëª…í™•í•œ êµ¬ë¶„, ë¦¬ìŠ¤íŠ¸ í™œìš©"
            };

            const prompt = `ìœ íŠœë¸Œ ì§€ì‹ ì±„ë„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜.

ì£¼ì œ: ${settings.topic}
ì¹´í…Œê³ ë¦¬: ${settings.category}
ìŠ¤íƒ€ì¼: ${styleGuides[settings.style]}
ëª©í‘œ ê¸¸ì´: ${settings.duration}ì´ˆ (ì•½ ${Math.floor(settings.duration/60)}ë¶„)
ì–¸ì–´: ${settings.language === 'ko' ? 'í•œêµ­ì–´' : settings.language === 'en' ? 'English' : 'æ—¥æœ¬èª'}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´:
{
  "titles": ["ì¶”ì²œ ì œëª© 1", "ì¶”ì²œ ì œëª© 2", "ì¶”ì²œ ì œëª© 3"],
  "hooks": ["ì‹œì‘ í›„í¬ ë©˜íŠ¸ 1", "ì‹œì‘ í›„í¬ ë©˜íŠ¸ 2"],
  "full_script": "ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©...",
  "key_points": ["í•µì‹¬ í¬ì¸íŠ¸ 1", "í•µì‹¬ í¬ì¸íŠ¸ 2", "í•µì‹¬ í¬ì¸íŠ¸ 3"],
  "cta": "êµ¬ë…/ì¢‹ì•„ìš” ìœ ë„ ë©˜íŠ¸"
}

ìŠ¤í¬ë¦½íŠ¸ ìš”êµ¬ì‚¬í•­:
1. ì²˜ìŒ 15ì´ˆì— ê°•ë ¥í•œ í›„í¬ (ì¶©ê²©ì  ì‚¬ì‹¤ì´ë‚˜ ì§ˆë¬¸)
2. êµ¬ì–´ì²´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ
3. ê° ì„¹ì…˜ ëª…í™•íˆ êµ¬ë¶„
4. ê²°ë¡ ì—ì„œ CTA í¬í•¨`;

            try {
                const result = await callGeminiAPI(prompt, { temperature: 0.7, maxTokens: 8000 });

                clearInterval(progressInterval);
                document.getElementById('progressFill').style.width = '100%';

                if (!result.success) {
                    throw new Error(result.error);
                }

                console.log(`Success with model: ${result.model}`);
                let text = result.data.candidates[0].content.parts[0].text;
                console.log('Raw response text:', text);

                // JSON ì¶”ì¶œ
                if (text.includes('```json')) {
                    text = text.split('```json')[1].split('```')[0];
                } else if (text.includes('```')) {
                    text = text.split('```')[1].split('```')[0];
                }

                // JSON íŒŒì‹± ì‹œë„
                let scriptData;
                try {
                    scriptData = JSON.parse(text.trim());
                } catch (parseError) {
                    console.error('JSON parse error, trying to fix...', parseError);
                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ ì¶”ì¶œ
                    scriptData = {
                        titles: [settings.topic],
                        hooks: [],
                        full_script: text,
                        key_points: [],
                        cta: "êµ¬ë…ê³¼ ì¢‹ì•„ìš” ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
                    };

                    // í…ìŠ¤íŠ¸ì—ì„œ JSON êµ¬ì¡° ì°¾ê¸° ì‹œë„
                    try {
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                            let cleanJson = jsonMatch[0]
                                .replace(/\n/g, '\\n')
                                .replace(/\r/g, '')
                                .replace(/\t/g, '\\t')
                                .replace(/(?<!\\)"/g, '"')
                                .replace(/,\s*}/g, '}')
                                .replace(/,\s*]/g, ']');
                            scriptData = JSON.parse(cleanJson);
                        }
                    } catch (e) {
                        console.log('JSON extraction failed, using raw text');
                    }
                }

                currentScript = scriptData;
                currentScript.settings = settings;
                currentScript.model = result.model;

                // ê¸°ë³¸ê°’ ë³´ì¥
                if (!currentScript.titles) currentScript.titles = [settings.topic];
                if (!currentScript.hooks) currentScript.hooks = ["ì˜ìƒì˜ ì‹œì‘ì…ë‹ˆë‹¤."];
                if (!currentScript.key_points) currentScript.key_points = ["í•µì‹¬ ë‚´ìš©"];
                if (!currentScript.full_script) currentScript.full_script = text;

                // ê²°ê³¼ í‘œì‹œ
                displayScriptResult();

            } catch (error) {
                console.error('Error generating script:', error);
                clearInterval(progressInterval);
                document.getElementById('generatingStatus').innerHTML = `
                    <div class="text-red-500 text-center">
                        <div class="text-6xl mb-4">âŒ</div>
                        <p class="text-xl font-medium">ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
                        <p class="mt-2">${error.message}</p>
                        <button onclick="generateScript()" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayScriptResult() {
            document.getElementById('generatingStatus').classList.add('hidden');
            document.getElementById('scriptResult').classList.remove('hidden');

            // ì¶”ì²œ ì œëª©
            const titlesHtml = currentScript.titles.map(t =>
                `<div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="copyText('${t.replace(/'/g, "\\'")}')">
                    ğŸ“Œ ${t}
                </div>`
            ).join('');
            document.getElementById('suggestedTitles').innerHTML = titlesHtml;

            // í›„í¬
            document.getElementById('hooks').innerHTML = currentScript.hooks.map(h => `<p class="mb-2">ğŸ¯ "${h}"</p>`).join('');

            // ì „ì²´ ìŠ¤í¬ë¦½íŠ¸
            document.getElementById('fullScript').textContent = currentScript.full_script;

            // í•µì‹¬ í¬ì¸íŠ¸
            const pointsHtml = currentScript.key_points.map(p =>
                `<div class="flex items-start gap-2"><span class="text-purple-600">âœ“</span><span>${p}</span></div>`
            ).join('');
            document.getElementById('keyPoints').innerHTML = pointsHtml;
        }

        // ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
        function copyScript() {
            navigator.clipboard.writeText(currentScript.full_script);
            alert('ìŠ¤í¬ë¦½íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í…ìŠ¤íŠ¸ ë³µì‚¬
        function copyText(text) {
            navigator.clipboard.writeText(text);
            alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ========== ì‹œë¦¬ì¦ˆ ìƒì„± (ì „ë¬¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ ì›Œí¬í”Œë¡œìš°) ==========

        /*
         * ì‹œë¦¬ì¦ˆ ìƒì„± ì›Œí¬í”Œë¡œìš°:
         *
         * [STEP 1] ì „ì²´ ê³¨ê²© ì„¤ê³„ (Series Bible)
         *   - ì‹œë¦¬ì¦ˆ ì „ì²´ ì•„í¬(arc) ì„¤ê³„
         *   - ê° ì—í”¼ì†Œë“œì˜ ì‹œì‘ì /ëì  ëª…í™•íˆ ì§€ì •
         *   - íƒ€ì„ë¼ì¸ ë˜ëŠ” ì£¼ì œ ì˜ì—­ ë¶„í• 
         *
         * [STEP 2] ì—í”¼ì†Œë“œ ê²½ê³„ ê²€ì¦
         *   - ê° ì—í”¼ì†Œë“œ ì»¤ë²„ë¦¬ì§€ í™•ì¸
         *   - ì¤‘ë³µ ì˜ì—­ ì—†ëŠ”ì§€ ê²€ì¦
         *   - ë¹ˆ êµ¬ê°„ ì—†ëŠ”ì§€ í™•ì¸
         *
         * [STEP 3] ìˆœì°¨ì  ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
         *   - ì´ì „ ëª¨ë“  ì—í”¼ì†Œë“œ ìš”ì•½ ì°¸ì¡°
         *   - ê²½ê³„ ë‚´ì—ì„œë§Œ ë‚´ìš© ì‘ì„±
         *   - ë‹¤ìŒ í¸ ì˜ˆê³ ë¡œ ì—°ê²°
         */

        async function generateSeries() {
            goToStep(3);

            document.getElementById('generatingStatus').classList.remove('hidden');
            document.getElementById('scriptResult').classList.add('hidden');
            document.getElementById('seriesResult').classList.add('hidden');

            const statusEl = document.getElementById('generatingStatus');

            const settings = {
                topic: selectedTopic.title,
                category: document.getElementById('category').value,
                style: document.getElementById('style').value,
                duration: parseInt(document.getElementById('duration').value),
                language: document.getElementById('language').value,
                episodeCount: parseInt(document.getElementById('episodeCount').value),
                seriesFormat: document.getElementById('seriesFormat').value,
                seriesTitle: document.getElementById('seriesTitle').value || selectedTopic.title
            };

            const formatGuides = {
                chronological: "ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì „ê°œ - ê° ì—í”¼ì†Œë“œëŠ” íŠ¹ì • ì‹œê¸°/ì‚¬ê±´ë§Œ ë‹¤ë£¸",
                thematic: "ì£¼ì œë³„ ë¶„ë¥˜ - ê° ì—í”¼ì†Œë“œëŠ” í•˜ë‚˜ì˜ ë…ë¦½ëœ ì¸¡ë©´ë§Œ ë‹¤ë£¸",
                ranking: "ìˆœìœ„/ë­í‚¹ í˜•ì‹ - ê° ì—í”¼ì†Œë“œëŠ” íŠ¹ì • ìˆœìœ„ êµ¬ê°„ë§Œ ë‹¤ë£¸",
                mystery: "ë¯¸ìŠ¤í„°ë¦¬ í˜•ì‹ - ì ì§„ì  ì§„ì‹¤ ê³µê°œ, ê° í¸ì€ í•˜ë‚˜ì˜ ë‹¨ì„œë§Œ",
                comparison: "ë¹„êµ/ëŒ€ê²° í˜•ì‹ - ê° ì—í”¼ì†Œë“œëŠ” í•˜ë‚˜ì˜ ëŒ€ê²° êµ¬ë„ë§Œ"
            };

            const styleGuides = {
                kurzgesagt: "ìš°ì£¼ì  ê´€ì , ì² í•™ì  í†¤, ì‹œê°ì  ì€ìœ  ì‚¬ìš©",
                knowledge_pirate: "ì¹œê·¼í•˜ê³  ì¬ë¯¸ìˆëŠ” ì„¤ëª…, êµ¬ì–´ì²´",
                veritasium: "íƒêµ¬ì , ì§ˆë¬¸í˜•, ì¼ë°˜ì  ì˜¤í•´ ë°”ë¡œì¡ê¸°",
                infographic: "ë°ì´í„° ì¤‘ì‹¬, ëª…í™•í•œ êµ¬ë¶„, ë¦¬ìŠ¤íŠ¸ í™œìš©"
            };

            try {
                // ========================================
                // STEP 1: ì‹œë¦¬ì¦ˆ ë°”ì´ë¸” (ì „ì²´ ê³¨ê²©) ìƒì„±
                // ========================================
                statusEl.innerHTML = `
                    <div class="text-6xl mb-4 loading">ğŸ“‹</div>
                    <p class="text-xl font-medium text-gray-700">STEP 1/3: ì‹œë¦¬ì¦ˆ ê³¨ê²© ì„¤ê³„ ì¤‘...</p>
                    <p class="text-gray-500 mt-2">ì „ì²´ ${settings.episodeCount}í¸ì˜ êµ¬ì¡°ë¥¼ ë¨¼ì € ì„¤ê³„í•©ë‹ˆë‹¤</p>
                    <div class="progress-bar w-64 mx-auto mt-4">
                        <div class="progress-fill" id="progressFill" style="width: 5%"></div>
                    </div>
                `;

                const biblePrompt = `ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ìœ íŠœë¸Œ ë‹¤íë©˜í„°ë¦¬ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤.
"${settings.seriesTitle}" ì£¼ì œë¡œ ${settings.episodeCount}í¸ì§œë¦¬ ì‹œë¦¬ì¦ˆì˜ 'ì‹œë¦¬ì¦ˆ ë°”ì´ë¸”(Series Bible)'ì„ ì‘ì„±í•˜ì„¸ìš”.

ì£¼ì œ: ${settings.topic}
ì¹´í…Œê³ ë¦¬: ${settings.category}
ì‹œë¦¬ì¦ˆ í˜•ì‹: ${formatGuides[settings.seriesFormat]}
ì—í”¼ì†Œë“œë‹¹ ê¸¸ì´: ì•½ ${Math.floor(settings.duration/60)}ë¶„

ğŸ¬ ì‹œë¦¬ì¦ˆ ë°”ì´ë¸” ì‘ì„± ê·œì¹™:

1. **ì „ì²´ ì•„í¬ ì„¤ê³„**: ì‹œë¦¬ì¦ˆ ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” í° ìŠ¤í† ë¦¬ë¼ì¸
2. **ì—í”¼ì†Œë“œë³„ ê²½ê³„ ì„¤ì •**: ê° ì—í”¼ì†Œë“œê°€ ë‹¤ë£° ë²”ìœ„ë¥¼ ëª…í™•íˆ (ì‹œì‘ì ~ëì )
3. **ì ˆëŒ€ ì¤‘ë³µ ê¸ˆì§€**: í•œ ì—í”¼ì†Œë“œì—ì„œ ë‹¤ë£¬ ë‚´ìš©ì€ ë‹¤ë¥¸ ì—í”¼ì†Œë“œì—ì„œ ì ˆëŒ€ ë‹¤ë£¨ì§€ ì•ŠìŒ
4. **ì—°ê²°ì„± í™•ë³´**: ê° ì—í”¼ì†Œë“œ ëì´ ë‹¤ìŒ ì—í”¼ì†Œë“œ ì‹œì‘ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ:
{
  "series_title": "ì‹œë¦¬ì¦ˆ ì œëª©",
  "series_description": "ì‹œë¦¬ì¦ˆ ì†Œê°œ (3ë¬¸ì¥)",
  "total_arc": "ì‹œë¦¬ì¦ˆ ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” ë©”ì¸ ìŠ¤í† ë¦¬/ì§ˆë¬¸",
  "target_audience": "íƒ€ê²Ÿ ì‹œì²­ì",
  "episodes": [
    {
      "episode_number": 1,
      "title": "ì—í”¼ì†Œë“œ ì œëª©",
      "subtitle": "ë¶€ì œëª©",
      "coverage_start": "ì´ ì—í”¼ì†Œë“œê°€ ë‹¤ë£¨ëŠ” ì‹œì‘ì  (ì‹œê¸°/ì£¼ì œ/ë²”ìœ„)",
      "coverage_end": "ì´ ì—í”¼ì†Œë“œê°€ ë‹¤ë£¨ëŠ” ëì  (ì‹œê¸°/ì£¼ì œ/ë²”ìœ„)",
      "boundary_rule": "ì´ ì—í”¼ì†Œë“œì—ì„œ ì ˆëŒ€ ë‹¤ë£¨ë©´ ì•ˆ ë˜ëŠ” ê²ƒ",
      "key_events": ["ì´ í¸ì—ì„œë§Œ ë‹¤ë£° í•µì‹¬ ì‚¬ê±´/ë‚´ìš© 1", "í•µì‹¬ ì‚¬ê±´/ë‚´ìš© 2", "í•µì‹¬ ì‚¬ê±´/ë‚´ìš© 3"],
      "hook": "ì˜¤í”„ë‹ í›„í¬ (ì‹œì²­ìë¥¼ ì‚¬ë¡œì¡ì„ ì²« ë¬¸ì¥)",
      "cliffhanger": "ì—”ë”© ì˜ˆê³  (ë‹¤ìŒ í¸ìœ¼ë¡œ ìœ ë„)",
      "connection_to_next": "ë‹¤ìŒ ì—í”¼ì†Œë“œì™€ì˜ ì—°ê²°ì "
    }
  ],
  "timeline_or_structure": "ì „ì²´ íƒ€ì„ë¼ì¸ ë˜ëŠ” êµ¬ì¡° ì„¤ëª…",
  "upload_schedule": "ì¶”ì²œ ì—…ë¡œë“œ ì¼ì •",
  "thumbnail_style": "ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ ì œì•ˆ"
}`;

                const bibleResult = await callGeminiAPI(biblePrompt, { temperature: 0.7, maxTokens: 8000 });

                if (!bibleResult.success) {
                    throw new Error(bibleResult.error);
                }

                let bibleText = bibleResult.data.candidates[0].content.parts[0].text;
                console.log('Series Bible:', bibleText);

                // JSON ì¶”ì¶œ
                if (bibleText.includes('```json')) {
                    bibleText = bibleText.split('```json')[1].split('```')[0];
                } else if (bibleText.includes('```')) {
                    bibleText = bibleText.split('```')[1].split('```')[0];
                }

                let seriesBible;
                try {
                    seriesBible = JSON.parse(bibleText.trim());
                } catch (e) {
                    const jsonMatch = bibleText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        seriesBible = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('ì‹œë¦¬ì¦ˆ ë°”ì´ë¸” íŒŒì‹± ì‹¤íŒ¨');
                    }
                }

                document.getElementById('progressFill').style.width = '20%';

                // ========================================
                // STEP 2: ì—í”¼ì†Œë“œ ê²½ê³„ ê²€ì¦ ë° ë³´ì™„
                // ========================================
                statusEl.innerHTML = `
                    <div class="text-6xl mb-4 loading">ğŸ”</div>
                    <p class="text-xl font-medium text-gray-700">STEP 2/3: ì—í”¼ì†Œë“œ ê²½ê³„ ê²€ì¦ ì¤‘...</p>
                    <p class="text-gray-500 mt-2">ê° ì—í”¼ì†Œë“œì˜ ë²”ìœ„ê°€ ê²¹ì¹˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤</p>
                    <div class="progress-bar w-64 mx-auto mt-4">
                        <div class="progress-fill" style="width: 25%"></div>
                    </div>
                `;

                // ì—í”¼ì†Œë“œ ê²½ê³„ ìš”ì•½ ìƒì„±
                const episodes = seriesBible.episodes || [];
                const episodeBoundaries = episodes.map((ep, idx) => ({
                    ep: idx + 1,
                    title: ep.title,
                    start: ep.coverage_start,
                    end: ep.coverage_end,
                    boundary: ep.boundary_rule,
                    events: ep.key_events
                }));

                console.log('Episode Boundaries:', episodeBoundaries);

                // ========================================
                // STEP 3: ìˆœì°¨ì  ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
                // ========================================
                const completedEpisodes = [];

                for (let i = 0; i < Math.min(episodes.length, settings.episodeCount); i++) {
                    const ep = episodes[i];
                    const progress = 30 + (i / episodes.length) * 65;

                    statusEl.innerHTML = `
                        <div class="text-6xl mb-4 loading">âœï¸</div>
                        <p class="text-xl font-medium text-gray-700">STEP 3/3: ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ì¤‘...</p>
                        <p class="text-gray-500 mt-2">ì—í”¼ì†Œë“œ ${i + 1}/${episodes.length}: ${ep.title}</p>
                        <div class="mt-2 text-sm text-purple-600">
                            ğŸ“ ë²”ìœ„: ${ep.coverage_start} â†’ ${ep.coverage_end}
                        </div>
                        <div class="progress-bar w-64 mx-auto mt-4">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    `;

                    // ì´ì „ ì—í”¼ì†Œë“œë“¤ì˜ ìš”ì•½ ìƒì„±
                    const previousSummary = completedEpisodes.map(ce =>
                        `[EP${ce.episode_number}] ${ce.title}: ${ce.coverage_start}~${ce.coverage_end} (ë‹¤ë£¬ ë‚´ìš©: ${ce.key_events?.join(', ')})`
                    ).join('\n');

                    // ë‹¤ë¥¸ ì—í”¼ì†Œë“œë“¤ì˜ ê²½ê³„ ì •ë³´
                    const otherBoundaries = episodeBoundaries
                        .filter((_, idx) => idx !== i)
                        .map(b => `EP${b.ep}: ${b.start}~${b.end}`)
                        .join(', ');

                    const scriptPrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ìœ íŠœë¸Œ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤.
ì‹œë¦¬ì¦ˆ "${seriesBible.series_title}"ì˜ ì—í”¼ì†Œë“œ ${ep.episode_number} ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ğŸ“‹ ì‹œë¦¬ì¦ˆ ì „ì²´ ì•„í¬: ${seriesBible.total_arc}

ğŸ“ ì´ ì—í”¼ì†Œë“œ ì •ë³´:
- ì œëª©: ${ep.title}
- ë¶€ì œëª©: ${ep.subtitle || ''}
- ì»¤ë²„ë¦¬ì§€ ì‹œì‘: ${ep.coverage_start}
- ì»¤ë²„ë¦¬ì§€ ë: ${ep.coverage_end}
- ì´ ì—í”¼ì†Œë“œì—ì„œë§Œ ë‹¤ë£° í•µì‹¬ ë‚´ìš©: ${ep.key_events?.join(', ')}
- ì ˆëŒ€ ë‹¤ë£¨ë©´ ì•ˆ ë˜ëŠ” ê²ƒ: ${ep.boundary_rule}
- ì˜¤í”„ë‹ í›„í¬: ${ep.hook}
- ì—”ë”© (ë‹¤ìŒ í¸ ì˜ˆê³ ): ${ep.cliffhanger}
- ë‹¤ìŒ í¸ ì—°ê²°ì : ${ep.connection_to_next || ''}

${previousSummary ? `
âš ï¸ ì´ì „ ì—í”¼ì†Œë“œì—ì„œ ì´ë¯¸ ë‹¤ë£¬ ë‚´ìš© (ì ˆëŒ€ ì¤‘ë³µ ê¸ˆì§€):
${previousSummary}
` : ''}

âš ï¸ ë‹¤ë¥¸ ì—í”¼ì†Œë“œë“¤ì˜ ë²”ìœ„ (ì´ ì˜ì—­ì€ ë‹¤ë£¨ì§€ ë§ˆì„¸ìš”):
${otherBoundaries}

ğŸ¯ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ê·œì¹™:
1. ë°˜ë“œì‹œ "${ep.coverage_start}"ì—ì„œ ì‹œì‘í•˜ì—¬ "${ep.coverage_end}"ì—ì„œ ëë‚  ê²ƒ
2. ${ep.boundary_rule}
3. ì˜¤í”„ë‹ì€ ë°˜ë“œì‹œ "${ep.hook}"ë¡œ ì‹œì‘
4. ì—”ë”©ì€ ë°˜ë“œì‹œ "${ep.cliffhanger}"ë¡œ ë§ˆë¬´ë¦¬
5. ê¸¸ì´: ${settings.duration}ì´ˆ (ì•½ ${Math.floor(settings.duration/60)}ë¶„) ë¶„ëŸ‰
6. ìŠ¤íƒ€ì¼: ${styleGuides[settings.style]}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ:
{
  "full_script": "ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ (${ep.hook}ë¡œ ì‹œì‘, ${ep.cliffhanger}ë¡œ ë)",
  "key_points": ["ì´ ì—í”¼ì†Œë“œì˜ í•µì‹¬ í¬ì¸íŠ¸ 1", "í•µì‹¬ í¬ì¸íŠ¸ 2", "í•µì‹¬ í¬ì¸íŠ¸ 3"],
  "covered_content": "ì´ ì—í”¼ì†Œë“œì—ì„œ ì‹¤ì œë¡œ ë‹¤ë£¬ ë‚´ìš© ìš”ì•½ (ë‹¤ìŒ ì—í”¼ì†Œë“œ ì°¸ì¡°ìš©)"
}`;

                    const scriptResult = await callGeminiAPI(scriptPrompt, { temperature: 0.7, maxTokens: 8000 });

                    if (scriptResult.success) {
                        let scriptText = scriptResult.data.candidates[0].content.parts[0].text;
                        if (scriptText.includes('```json')) {
                            scriptText = scriptText.split('```json')[1].split('```')[0];
                        } else if (scriptText.includes('```')) {
                            scriptText = scriptText.split('```')[1].split('```')[0];
                        }

                        try {
                            const scriptData = JSON.parse(scriptText.trim());
                            episodes[i].script = scriptData.full_script || scriptText;
                            episodes[i].key_points = scriptData.key_points || [];
                            episodes[i].covered_content = scriptData.covered_content || '';
                        } catch (e) {
                            episodes[i].script = scriptText;
                            episodes[i].key_points = [];
                            episodes[i].covered_content = ep.key_events?.join(', ') || '';
                        }
                    } else {
                        episodes[i].script = `[ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨]\n\nì—í”¼ì†Œë“œ ì œëª©: ${ep.title}\në²”ìœ„: ${ep.coverage_start} ~ ${ep.coverage_end}`;
                        episodes[i].key_points = [];
                        episodes[i].covered_content = '';
                    }

                    // ì™„ë£Œëœ ì—í”¼ì†Œë“œ ê¸°ë¡ (ë‹¤ìŒ ì—í”¼ì†Œë“œ ìƒì„± ì‹œ ì°¸ì¡°)
                    completedEpisodes.push({
                        episode_number: ep.episode_number,
                        title: ep.title,
                        coverage_start: ep.coverage_start,
                        coverage_end: ep.coverage_end,
                        key_events: ep.key_events,
                        covered_content: episodes[i].covered_content
                    });
                }

                // ========================================
                // ì™„ë£Œ: ì‹œë¦¬ì¦ˆ ë°ì´í„° ì €ì¥
                // ========================================
                statusEl.innerHTML = `
                    <div class="text-6xl mb-4">âœ…</div>
                    <p class="text-xl font-medium text-gray-700">ì‹œë¦¬ì¦ˆ ìƒì„± ì™„ë£Œ!</p>
                    <div class="progress-bar w-64 mx-auto mt-4">
                        <div class="progress-fill" style="width: 100%"></div>
                    </div>
                `;

                currentSeries = {
                    ...seriesBible,
                    episodes: episodes,
                    settings: settings,
                    workflow: 'professional_screenwriter_v2',
                    createdAt: new Date().toISOString()
                };

                // ê²°ê³¼ í‘œì‹œ
                setTimeout(() => displaySeriesResult(), 500);

            } catch (error) {
                console.error('Error generating series:', error);
                statusEl.innerHTML = `
                    <div class="text-red-500 text-center">
                        <div class="text-6xl mb-4">âŒ</div>
                        <p class="text-xl font-medium">ì‹œë¦¬ì¦ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
                        <p class="mt-2">${error.message}</p>
                        <button onclick="generateSeries()" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        // ì‹œë¦¬ì¦ˆ ê²°ê³¼ í‘œì‹œ
        function displaySeriesResult() {
            document.getElementById('generatingStatus').classList.add('hidden');
            document.getElementById('scriptResult').classList.add('hidden');
            document.getElementById('seriesResult').classList.remove('hidden');

            const series = currentSeries;

            // ì„±ê³µ ë©”ì‹œì§€
            document.getElementById('seriesSuccessMsg').textContent =
                `"${series.series_title}" ì‹œë¦¬ì¦ˆ ${series.episodes.length}í¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`;

            // ì‹œë¦¬ì¦ˆ ê°œìš”
            document.getElementById('seriesOverview').innerHTML = `
                <h4 class="font-bold text-xl text-purple-800 mb-2">${series.series_title}</h4>
                <p class="text-gray-600 mb-3">${series.series_description || ''}</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div class="bg-purple-50 p-2 rounded-lg text-center">
                        <div class="text-purple-600 font-bold">${series.episodes.length}í¸</div>
                        <div class="text-gray-500">ì—í”¼ì†Œë“œ</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-lg text-center">
                        <div class="text-blue-600 font-bold">${series.target_audience || 'ì¼ë°˜'}</div>
                        <div class="text-gray-500">íƒ€ê²Ÿ</div>
                    </div>
                    <div class="bg-green-50 p-2 rounded-lg text-center">
                        <div class="text-green-600 font-bold">${series.upload_schedule || 'ì£¼ 1íšŒ'}</div>
                        <div class="text-gray-500">ì—…ë¡œë“œ</div>
                    </div>
                    <div class="bg-yellow-50 p-2 rounded-lg text-center">
                        <div class="text-yellow-600 font-bold">${series.thumbnail_style || 'í†µì¼ ë””ìì¸'}</div>
                        <div class="text-gray-500">ì¸ë„¤ì¼</div>
                    </div>
                </div>
            `;

            // ì—í”¼ì†Œë“œ ëª©ë¡
            let episodesHtml = '';
            series.episodes.forEach((ep, idx) => {
                episodesHtml += `
                    <div class="border rounded-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-100 to-blue-100 p-4 cursor-pointer" onclick="toggleEpisode(${idx})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-bold">EP${ep.episode_number || idx + 1}</span>
                                    <div>
                                        <h4 class="font-bold text-gray-800">${ep.title}</h4>
                                        <p class="text-sm text-gray-500">${ep.subtitle || ''}</p>
                                    </div>
                                </div>
                                <span class="text-2xl" id="episodeArrow${idx}">â–¼</span>
                            </div>
                            ${ep.coverage_start ? `
                                <div class="mt-2 text-xs text-purple-700 bg-purple-50 px-2 py-1 rounded inline-block">
                                    ğŸ“ ${ep.coverage_start} â†’ ${ep.coverage_end}
                                </div>
                            ` : ''}
                        </div>
                        <div id="episodeContent${idx}" class="hidden p-4 bg-white">
                            ${ep.coverage_start ? `
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                    <h5 class="font-medium text-sm text-blue-800 mb-2">ğŸ“ ì´ ì—í”¼ì†Œë“œì˜ ë²”ìœ„</h5>
                                    <div class="text-sm text-blue-700">
                                        <p><strong>ì‹œì‘:</strong> ${ep.coverage_start}</p>
                                        <p><strong>ë:</strong> ${ep.coverage_end}</p>
                                        ${ep.boundary_rule ? `<p class="mt-1 text-red-600"><strong>âš ï¸ ê²½ê³„:</strong> ${ep.boundary_rule}</p>` : ''}
                                    </div>
                                </div>
                            ` : ''}

                            ${ep.key_events?.length ? `
                                <div class="mb-4 p-3 bg-green-50 rounded-lg">
                                    <h5 class="font-medium text-sm text-green-800 mb-2">ğŸ¯ ì´ í¸ì—ì„œ ë‹¤ë£¨ëŠ” ë‚´ìš©</h5>
                                    <ul class="list-disc list-inside text-sm text-green-700">
                                        ${ep.key_events.map(e => `<li>${e}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${ep.hook ? `<div class="bg-yellow-50 p-2 rounded-lg text-sm mb-4"><strong>ğŸ¬ ì˜¤í”„ë‹ í›„í¬:</strong> "${ep.hook}"</div>` : ''}

                            ${ep.key_points?.length ? `
                                <div class="mb-4">
                                    <h5 class="font-medium text-sm text-gray-700 mb-2">ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸</h5>
                                    <ul class="list-disc list-inside text-sm text-gray-600">
                                        ${ep.key_points.map(p => `<li>${p}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <div class="mb-4">
                                <h5 class="font-medium text-sm text-gray-700 mb-2">ğŸ“œ ìŠ¤í¬ë¦½íŠ¸</h5>
                                <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 max-h-64 overflow-y-auto whitespace-pre-wrap">${ep.script || 'ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ'}</div>
                            </div>

                            ${ep.cliffhanger ? `<div class="bg-purple-50 p-2 rounded-lg text-sm mb-2"><strong>ğŸ”® ì—”ë”© (ë‹¤ìŒ í¸ ì˜ˆê³ ):</strong> "${ep.cliffhanger}"</div>` : ''}
                            ${ep.connection_to_next ? `<div class="bg-gray-100 p-2 rounded-lg text-sm text-gray-600"><strong>ğŸ”— ë‹¤ìŒ í¸ ì—°ê²°:</strong> ${ep.connection_to_next}</div>` : ''}

                            <div class="flex gap-2 mt-4">
                                <button onclick="copyEpisodeScript(${idx})" class="flex-1 px-3 py-2 bg-gray-100 rounded-lg text-sm hover:bg-gray-200">
                                    ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
                                </button>
                                <button onclick="downloadEpisode(${idx})" class="flex-1 px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200">
                                    ğŸ’¾ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('episodeList').innerHTML = episodesHtml;
        }

        // ì—í”¼ì†Œë“œ í† ê¸€
        function toggleEpisode(idx) {
            const content = document.getElementById(`episodeContent${idx}`);
            const arrow = document.getElementById(`episodeArrow${idx}`);
            content.classList.toggle('hidden');
            arrow.textContent = content.classList.contains('hidden') ? 'â–¼' : 'â–²';
        }

        // ì—í”¼ì†Œë“œ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
        function copyEpisodeScript(idx) {
            const script = currentSeries.episodes[idx]?.script || '';
            navigator.clipboard.writeText(script);
            alert(`ì—í”¼ì†Œë“œ ${idx + 1} ìŠ¤í¬ë¦½íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ì—í”¼ì†Œë“œ ë‹¤ìš´ë¡œë“œ
        function downloadEpisode(idx) {
            const ep = currentSeries.episodes[idx];
            const content = `
================================================================================
ğŸ“š ${currentSeries.series_title}
ğŸ¬ ì—í”¼ì†Œë“œ ${ep.episode_number || idx + 1}: ${ep.title}
================================================================================

ğŸ“Œ ë¶€ì œëª©: ${ep.subtitle || '-'}
ğŸ“ ì„¤ëª…: ${ep.description || '-'}

ğŸ¯ ì˜¤í”„ë‹ í›„í¬:
"${ep.hook || '-'}"

================================================================================
ğŸ“œ ìŠ¤í¬ë¦½íŠ¸
================================================================================

${ep.script || 'ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ'}

================================================================================
ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸
================================================================================
${ep.key_points?.map((p, i) => `${i + 1}. ${p}`).join('\n') || '-'}

================================================================================
ğŸ”® ë‹¤ìŒ í¸ ì˜ˆê³ 
================================================================================
"${ep.cliffhanger || '-'}"

================================================================================
ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
================================================================================
`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EP${ep.episode_number || idx + 1}_${ep.title.slice(0, 20)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ì „ì²´ ì‹œë¦¬ì¦ˆ ë‹¤ìš´ë¡œë“œ
        function downloadSeriesAll() {
            const series = currentSeries;
            let content = `
================================================================================
ğŸ“š ${series.series_title} - ì „ì²´ ì‹œë¦¬ì¦ˆ ìë£Œ
================================================================================

ğŸ“ ì‹œë¦¬ì¦ˆ ì†Œê°œ: ${series.series_description || '-'}
ğŸ¯ íƒ€ê²Ÿ ì‹œì²­ì: ${series.target_audience || '-'}
ğŸ“… ì¶”ì²œ ì—…ë¡œë“œ: ${series.upload_schedule || '-'}
ğŸ–¼ï¸ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼: ${series.thumbnail_style || '-'}

ì´ ì—í”¼ì†Œë“œ: ${series.episodes.length}í¸

`;

            series.episodes.forEach((ep, idx) => {
                content += `
================================================================================
ğŸ¬ ì—í”¼ì†Œë“œ ${ep.episode_number || idx + 1}: ${ep.title}
================================================================================
ë¶€ì œëª©: ${ep.subtitle || '-'}
ì„¤ëª…: ${ep.description || '-'}
í›„í¬: "${ep.hook || '-'}"

[ìŠ¤í¬ë¦½íŠ¸]
${ep.script || 'ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ'}

[í•µì‹¬ í¬ì¸íŠ¸]
${ep.key_points?.map((p, i) => `${i + 1}. ${p}`).join('\n') || '-'}

[ë‹¤ìŒ í¸ ì˜ˆê³ ]
"${ep.cliffhanger || '-'}"

`;
            });

            content += `
================================================================================
ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
================================================================================
`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${series.series_title}_ì „ì²´ì‹œë¦¬ì¦ˆ.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ì‹œë¦¬ì¦ˆ í”„ë¡œì íŠ¸ ì €ì¥
        async function saveSeriesProject() {
            try {
                await db.collection('projects').add({
                    type: 'series',
                    series_title: currentSeries.series_title,
                    topic: currentSeries.settings?.topic,
                    category: currentSeries.settings?.category,
                    style: currentSeries.settings?.style,
                    episode_count: currentSeries.episodes?.length,
                    series_data: JSON.stringify(currentSeries),
                    status: 'series_complete',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ì‹œë¦¬ì¦ˆê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadRecentProjects();
            } catch (error) {
                console.error('Error saving series:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ========== ì˜ìƒ ì œì‘ ë„êµ¬ ==========

        // TTS ìŒì„± ìƒì„± (Web Speech API)
        let currentUtterance = null;

        function generateTTS() {
            if (!currentScript || !currentScript.full_script) {
                alert('ë¨¼ì € ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê¸°ì¡´ ìŒì„± ì¤‘ì§€
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const statusEl = document.getElementById('ttsStatus');
            statusEl.classList.remove('hidden');
            statusEl.textContent = 'ğŸ”Š ìŒì„±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            const text = currentScript.full_script;
            const voiceSelect = document.getElementById('ttsVoice').value;

            currentUtterance = new SpeechSynthesisUtterance(text);

            // ìŒì„± ì„¤ì •
            const voices = speechSynthesis.getVoices();
            let selectedVoice = voices.find(v => v.lang.startsWith('ko'));

            if (voiceSelect === 'en-US') {
                selectedVoice = voices.find(v => v.lang.startsWith('en'));
            }

            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
            }

            currentUtterance.lang = voiceSelect.startsWith('ko') ? 'ko-KR' : 'en-US';
            currentUtterance.rate = 1.0;
            currentUtterance.pitch = 1.0;

            currentUtterance.onstart = () => {
                statusEl.textContent = 'â–¶ï¸ ì¬ìƒ ì¤‘... (í´ë¦­í•˜ë©´ ì¤‘ì§€)';
                statusEl.onclick = () => speechSynthesis.cancel();
            };

            currentUtterance.onend = () => {
                statusEl.textContent = 'âœ… ì¬ìƒ ì™„ë£Œ!';
                statusEl.onclick = null;
            };

            currentUtterance.onerror = (e) => {
                statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + e.error;
            };

            speechSynthesis.speak(currentUtterance);
        }

        // TTS ë‹¤ìš´ë¡œë“œ ì•ˆë‚´
        function downloadTTS() {
            alert('ğŸ’¡ TTS ë‹¤ìš´ë¡œë“œ ë°©ë²•:\n\n' +
                '1. ë¬´ë£Œ TTS ì‚¬ì´íŠ¸ ì´ìš©:\n' +
                '   - ttsfree.com\n' +
                '   - ttsmaker.com\n' +
                '   - naturalreaders.com\n\n' +
                '2. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°\n' +
                '3. MP3ë¡œ ë‹¤ìš´ë¡œë“œ\n\n' +
                'ë˜ëŠ” ë„¤ì´ë²„ í´ë¡œë°”, ì¹´ì¹´ì˜¤ TTS ì‚¬ìš© ì¶”ì²œ!');

            // ìŠ¤í¬ë¦½íŠ¸ ìë™ ë³µì‚¬
            navigator.clipboard.writeText(currentScript.full_script);
        }

        // ì´ë¯¸ì§€ ê²€ìƒ‰
        function searchImages() {
            if (!currentScript) {
                alert('ë¨¼ì € ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const topic = currentScript.settings?.topic || selectedTopic?.title || '';
            const keywords = extractKeywords(topic);

            // Unsplash ê²€ìƒ‰ URL ì—´ê¸°
            const searchQuery = encodeURIComponent(keywords.join(' '));
            window.open(`https://unsplash.com/s/photos/${searchQuery}`, '_blank');

            // ì´ë¯¸ì§€ ê²°ê³¼ í‘œì‹œ
            const resultsEl = document.getElementById('imageResults');
            resultsEl.classList.remove('hidden');
            resultsEl.innerHTML = keywords.map(kw =>
                `<a href="https://unsplash.com/s/photos/${encodeURIComponent(kw)}" target="_blank"
                    class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300 transition text-center p-2">
                    <span class="text-xs text-gray-600">${kw}</span>
                </a>`
            ).join('');
        }

        // í‚¤ì›Œë“œ ì¶”ì¶œ
        function extractKeywords(topic) {
            // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ì¶”ì¶œ
            const words = topic.replace(/[^ê°€-í£a-zA-Z0-9\s]/g, '').split(/\s+/);
            const stopWords = ['ì˜', 'ë¥¼', 'ì„', 'ì´', 'ê°€', 'ì€', 'ëŠ”', 'TOP', 'ìœ„í•œ', 'í•˜ëŠ”', 'ìˆëŠ”', 'ë°©ë²•'];
            return words.filter(w => w.length > 1 && !stopWords.includes(w)).slice(0, 6);
        }

        // ì „ì²´ ë‹¤ìš´ë¡œë“œ
        function downloadAll() {
            if (!currentScript) {
                alert('ë¨¼ì € ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const topic = currentScript.settings?.topic || 'ì˜ìƒ';
            const keywords = extractKeywords(topic);

            const content = `
================================================================================
ğŸ¬ AI ìœ íŠœë¸Œ ì˜ìƒ ìë£Œ
================================================================================

ğŸ“Œ ì œëª© ì˜µì…˜:
${currentScript.titles?.map((t, i) => `${i + 1}. ${t}`).join('\n') || topic}

================================================================================

ğŸ¯ ì˜¤í”„ë‹ í›„í¬:
${currentScript.hooks?.map(h => `"${h}"`).join('\n') || ''}

================================================================================

ğŸ“œ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸:

${currentScript.full_script || ''}

================================================================================

ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸:
${currentScript.key_points?.map((p, i) => `${i + 1}. ${p}`).join('\n') || ''}

================================================================================

ğŸ–¼ï¸ ì´ë¯¸ì§€ ê²€ìƒ‰ ë§í¬:
${keywords.map(kw => `- ${kw}: https://unsplash.com/s/photos/${encodeURIComponent(kw)}`).join('\n')}

================================================================================

ğŸ¥ ì¶”ì²œ ì˜ìƒ í¸ì§‘ ë„êµ¬:
- Canva (ë¬´ë£Œ): https://www.canva.com/video-editor/
- CapCut (ë¬´ë£Œ): https://www.capcut.com/
- Clipchamp (MS ë¬´ë£Œ): https://clipchamp.com/
- VEED (ì›¹ ê¸°ë°˜): https://www.veed.io/

ğŸ”Š ë¬´ë£Œ TTS ì‚¬ì´íŠ¸:
- https://ttsfree.com
- https://ttsmaker.com
- https://naturalreaders.com

================================================================================
ìƒì„± ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}
================================================================================
`;

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ìœ íŠœë¸Œ_ì˜ìƒ_ìë£Œ_${topic.slice(0, 20)}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            alert('âœ… ìë£Œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ìš´ë¡œë“œëœ íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ ê²€ìƒ‰ ë§í¬ì™€ TTS ì‚¬ì´íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }

        // ìŒì„± ëª©ë¡ ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                const voices = speechSynthesis.getVoices();
                console.log('Available voices:', voices.filter(v => v.lang.startsWith('ko') || v.lang.startsWith('en')).map(v => v.name));
            };
        }

        // ========== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ==========

        // í”„ë¡œì íŠ¸ ì €ì¥
        async function saveProject() {
            try {
                await db.collection('projects').add({
                    topic: currentScript.settings.topic,
                    category: currentScript.settings.category,
                    style: currentScript.settings.style,
                    titles: currentScript.titles,
                    script: currentScript.full_script,
                    hooks: currentScript.hooks,
                    key_points: currentScript.key_points,
                    status: 'script_complete',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadRecentProjects();
            } catch (error) {
                console.error('Error saving project:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ìµœê·¼ í”„ë¡œì íŠ¸ ë¡œë“œ
        async function loadRecentProjects() {
            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();

                const container = document.getElementById('recentProjects');

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('ko-KR') : '';
                    const isSeries = data.type === 'series';
                    const title = isSeries ? (data.series_title || data.topic) : (data.topic || 'Untitled');
                    const badgeClass = isSeries ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700';
                    const badgeText = isSeries ? `ğŸ“š ${data.episode_count || '?'}í¸` : (data.status || 'saved');

                    html += `
                        <div class="p-4 bg-gray-50 rounded-xl hover:bg-gray-100 cursor-pointer" onclick="loadProjectEnhanced('${doc.id}')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-gray-800">${isSeries ? 'ğŸ“š ' : 'ğŸ¬ '}${title}</p>
                                    <p class="text-sm text-gray-500">${data.category || ''} â€¢ ${date}</p>
                                </div>
                                <span class="text-xs px-2 py-1 ${badgeClass} rounded">${badgeText}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // í”„ë¡œì íŠ¸ ë¡œë“œ
        async function loadProject(projectId) {
            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    const data = doc.data();
                    currentScript = {
                        titles: data.titles || [data.topic],
                        hooks: data.hooks || [],
                        full_script: data.script || '',
                        key_points: data.key_points || [],
                        settings: { topic: data.topic, category: data.category, style: data.style }
                    };
                    selectedTopic = { title: data.topic, category: data.category };
                    goToStep(3);
                    displayScriptResult();
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }

        // ì²˜ìŒë¶€í„° ë‹¤ì‹œ
        function startOver() {
            selectedTopic = null;
            currentScript = null;
            currentSeries = null;
            isSeriesMode = false;
            document.getElementById('customTopic').value = '';
            document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('selected'));
            // ì‹œë¦¬ì¦ˆ ëª¨ë“œ ì´ˆê¸°í™”
            document.querySelector('input[name="videoMode"][value="single"]').checked = true;
            document.getElementById('seriesSettings').classList.add('hidden');
            document.getElementById('generateBtnText').textContent = 'ìŠ¤í¬ë¦½íŠ¸ ìƒì„±í•˜ê¸°';
            document.getElementById('seriesTitle').value = '';
            // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('seriesResult').classList.add('hidden');
            document.getElementById('scriptResult').classList.add('hidden');
            goToStep(1);
        }

        // í”„ë¡œì íŠ¸ ë¡œë“œ (ì‹œë¦¬ì¦ˆ ì§€ì›)
        async function loadProjectEnhanced(projectId) {
            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    const data = doc.data();

                    if (data.type === 'series' && data.series_data) {
                        // ì‹œë¦¬ì¦ˆ í”„ë¡œì íŠ¸ ë¡œë“œ
                        currentSeries = JSON.parse(data.series_data);
                        goToStep(3);
                        displaySeriesResult();
                    } else {
                        // ë‹¨ì¼ ì˜ìƒ í”„ë¡œì íŠ¸ ë¡œë“œ
                        currentScript = {
                            titles: data.titles || [data.topic],
                            hooks: data.hooks || [],
                            full_script: data.script || '',
                            key_points: data.key_points || [],
                            settings: { topic: data.topic, category: data.category, style: data.style }
                        };
                        selectedTopic = { title: data.topic, category: data.category };
                        goToStep(3);
                        displayScriptResult();
                    }
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }
    </script>
</body>
</html>
